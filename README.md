# Roro MVC Theme 改修版（オールインワンパック）

この ZIP パッケージは、`roro_mvc_theme_final_star_update_phase_complete.zip` を基に、レポートで指摘されたフェーズ1〜3の不足を補う改修を加えた“オールインワン”版です。テーマ本体に加えて、必要な SQL スクリプトと導入手順が含まれています。

## 構成

```
/ (ルート)
│
├── theme/                 … 改修済み WordPress テーマ一式
├── sql/                   … DB スキーマ改修用 SQL
│   ├── 01_image_url.sql   … 雑誌ページに `image_url` カラムを追加
│   ├── 02_indexes_fk.sql  … インデックスや外部キーの追加
│   ├── 03_cleanup_policies.sql … 古い閲覧ログを自動削除する MySQL イベント
│   ├── 04_events_date_migration.sql … イベントテーブルに `id`・`event_date` 列を追加し日付を DATE 型に正規化
│   └── 04_spots_id_migration.sql … スポットテーブルに自動採番 `id` 列と `TSM_ID` のユニークインデックスを追加
└── README.md             … このドキュメント
```

## 主な変更点

- **プロフィール管理の実装**: `RORO_CUSTOMER` と `RORO_ADDRESS` に対する更新機能を提供する REST エンドポイント (`/roro/v1/profile`) を追加し、プロフィール編集用のショートコード `[roro_profile_form]` を実装しました。
- **ペット管理の拡張**: ユーザーが複数のペットを追加・更新・削除できるよう、REST エンドポイント (`/roro/v1/pets`) とペット管理ショートコード `[roro_pets_panel]` を実装しました。
- **管理画面の追加**: WordPress 管理メニューに「Roro 管理」セクションを追加し、イベント (`RORO_EVENTS_MASTER`) と雑誌 (`RORO_MAGAZINE_ISSUE` / `RORO_MAGAZINE_PAGE`) の CRUD 操作を行うための簡易 UI を提供します。
- **REST API 統一**: イベント／雑誌／プロフィール／ペットの操作は REST API 経由で行われるようになり、今後の機能拡張が容易になりました。
- **連動削除の実装**: ユーザー削除時に顧客情報やペット、お気に入り、住所など関連テーブルを自動削除します。
- **ログの定期削除**: `wp_cron` と MySQL イベントの双方で雑誌閲覧ログの古いレコードを自動削除できる仕組みを追加しました。
- **画像URL カラムの追加**: 雑誌ページテーブルに `image_url` カラムを追加し、BLOB ではなく URL で画像を指定できるようにしました。
- **各種インデックスと外部キー**: ペットや住所などのテーブルにインデックスおよび外部キーを追加し、リレーションの整合性とパフォーマンスを向上させます。

### 2025-09-15 更新内容 (Stage10)

- **推薦機能の高度化**: 新しい `/roro/v1/recommend-events-advanced` エンドポイントを追加しました。このエンドポイントでは、イベントのお気に入り件数や開催日までの日数、リクエストユーザーがお気に入り登録しているかどうかを総合したスコアを用いて上位5件を返します。近い開催日やユーザーの嗜好に基づく推薦理由を日本語・英語で表示することで、個人化されたレコメンド体験を向上させます。
- **翻訳・UI メッセージの拡充**: ナビゲーションアイコンや雑誌ページの見出しに対応した翻訳キーを追加し、多言語表示の精度を高めました。新しいおすすめ理由にも翻訳キーを追加しています。

### 2025‑09 改修での追加ポイント（Phase1〜3 対応）

- **イベント日付の正規化**: `sql/04_events_date_migration.sql` により `RORO_EVENTS_MASTER` テーブルに自動採番カラム `id` と DATE 型の `event_date` 列を追加し、既存の `date` 文字列から日付値を移行します。REST/管理画面では `event_date` が優先的に利用されます。
- **アナリティクス管理画面**: 管理メニューに「アナリティクス」を追加し、雑誌閲覧／クリックの集計データを日付範囲や号単位で確認・CSV ダウンロードできるダッシュボードを実装しました。データ取得は `/roro/v1/analytics` REST エンドポイント経由で行います。
- **お気に入りの REST 化**: 従来の Ajax アクションに代わり、`/roro/v1/favorites`（GET/POST）および `/roro/v1/favorites/{target_type}/{target_id}`（DELETE）エンドポイントを追加し、フロントの `favorites.js` を REST 呼び出しに統一しました。イベント／スポットの情報を含んだお気に入り一覧を取得できます。
- **プロフィール入力検証**: プロフィール更新時に郵便番号・電話番号の形式をサーバ側で検証します（郵便番号は `123-4567` or `1234567`、電話番号は10〜15桁の数字／ハイフン）。不正な入力の場合は 400 エラーを返します。
- **アナリティクス API**: 管理者専用に `/roro/v1/analytics` を実装し、`RORO_MAGAZINE_DAILY` の集計データを JSON 形式で返します。`start_date`・`end_date`・`issue_id` パラメータでフィルタリングが可能です。
- **お気に入り API**: `/roro/v1/favorites` は現在ログイン中のユーザーのお気に入りを取得・追加・削除できます。レスポンスには対象イベント／スポットの名称・日付・場所等が含まれます。

### 2025‑09-13 更新での追加ポイント（Phase3 対応）

- **スポット機能の実装**: `RORO_TRAVEL_SPOT_MASTER` に自動採番 `id` 列と `TSM_ID` ユニークインデックスを追加する `sql/04_spots_id_migration.sql` を追加しました。テーマ内では `SpotsModel` を用いて CRUD 操作を行い、REST エンドポイント `/roro/v1/spots`（GET/POST/PUT/DELETE）を新設しました。管理画面に「スポット管理」を追加し、スポットの登録・削除が可能です。
- **未使用機能の整理**: これまで搭載されていた Dify AI チャット UI やカスタムチャット UI は未実装であるため、本パッケージでは利用されていません。将来的に導入する場合は別途実装してください。
- **ドキュメントの更新**: README を更新し、新規追加機能や未使用モジュールについて明示しました。

### 2025‑09-13 更新での追加ポイント（Phase1・4 対応）

 - **スポットのフロント統合**: 地図ページ (`page-map.php`) が REST API `/roro/v1/spots` を呼び出してペット向けスポットを取得し、イベントと同様にマーカー表示するようになりました。カテゴリバーに「スポット」が追加され、マーカーはオレンジ色で表示されます。スポット詳細にはお気に入りボタンがあり、クリックすると REST API `/roro/v1/favorites` 経由で `target_type=spot` として登録されます。カテゴリー・フィルタボタンにもスポットが追加されています。
 - **トレンドイベントとレコメンド API**: お気に入りページにお気に入り数が多い「トレンドイベント」枠を追加しました。将来の AI レコメンド導入に備え、暫定の推奨エンドポイント `/roro/v1/recommend-events` と `/roro/v1/recommend-magazine` も実装しています。

### 2025‑09-14 更新での追加ポイント（Phase2 承認/公開フロー）

- **下書き／公開ステータスの導入**: `RORO_EVENTS_MASTER`, `RORO_TRAVEL_SPOT_MASTER`, `RORO_ONE_POINT_ADVICE_MASTER` に `status` と `status_updated_at` カラムを追加し、既存のデータを `isVisible=1` なら `published` へ、それ以外は `draft` へ初期化しました。これによりデータの公開・下書き状態を分けて管理できます。変更履歴は新テーブル `RORO_STATUS_HISTORY` に自動記録されます。これらの変更は `sql/05_status_migration.sql` に含まれていますので、必ず適用してください。
- **REST API とモデルの対応**: イベント／スポット／アドバイスの REST エンドポイントはデフォルトで `status='published'` かつ `isVisible=1` のデータのみを返すようになりました。管理者が `?all=1` パラメータを付けた場合は下書きを含む全件を取得できます。また、`status` パラメータを指定して `draft` 又は `published` のみを絞り込むことも可能です（管理者のみ）。
- **管理画面のステータス操作**: イベント・スポット・アドバイスの管理フォームに「下書き／公開」セレクトボックスを追加し、新規登録時は `draft` がデフォルトとなります。一覧画面にはステータス列を追加し、編集時にステータス値を読み込んで更新できるようになりました。さらに「表示ステータス」フィルターを管理画面の一覧上部に追加し、`すべて`／`公開のみ`／`下書きのみ` を選択して絞り込みができます。
- **フロント側への影響**: 一般ユーザー向けの地図ページや雑誌ページ、プロフィールやペット機能などでは、公開 (`published`) 状態のデータのみが表示されます。下書きデータは管理画面でのみ閲覧・編集可能です。
- **履歴管理**: ステータス変更時には `RORO_STATUS_HISTORY` に変更前後のステータス、テーブル名、レコードID、更新者ID、変更時刻が記録され、後から履歴を追跡できます（閲覧 UI はまだありませんが、DB に保存されています）。

### 2025‑09‑15 更新での追加ポイント（Phase1 仕上げ）

 - **イベントの DB 直取得化**: 地図ページが `data/events.js` に依存していた静的イベントリストを廃止し、REST API `/roro/v1/events` から最新のイベントを取得してマーカーを生成するようにしました。`page-map.php` から `events.js` の読み込みを外し、`map.js` では初期化時に同期的に API 呼び出しを行い、`window.eventsData` を上書きして従来のロジックを流用しています。API が利用できない場合は静的データをフォールバックとして使用します。

 - **イベントお気に入りの REST 化**: マップ上のイベント詳細カードから「お気に入り」を登録する際、これまではローカルストレージのみを利用していましたが、`addToFavorites()` 関数を修正し、`target_type=event` と `target_id` を指定して REST API `/roro/v1/favorites` に POST するようにしました。登録成功後はローカルストレージにも簡易コピーを保存します。これによりイベントのお気に入りもスポットと同様にサーバと同期されます。
- **README の追記**: 本ドキュメントにイベント REST 化の概要と実装方針を追加しました。


### 2025‑09‑16 更新での追加ポイント（Phase2 取りかかり）

フェーズ2（管理機能の実装）の初期対応として、以下の強化を行いました。

- **管理画面のCSVエクスポート機能**: イベント管理ページおよびスポット管理ページの一覧上部に「CSVダウンロード」ボタンを追加しました。ボタンをクリックすると、`/roro/v1/events?all=1` あるいは `/roro/v1/spots?all=1` から全件を取得し、各項目をカンマ区切りにした CSV ファイルがブラウザからダウンロードされます。取得データには公開／下書きの両方が含まれ、ヘッダーには ID・名称・日付・場所・緯度・経度・ステータス等が含まれます。
- **フォーム入力のクライアント検証**: 管理画面のイベント登録フォームでは、イベント名と日付の入力有無を JavaScript でチェックし、緯度・経度が数値でない場合はアラートを表示して送信をキャンセルするようにしました。同様に、スポット登録フォームでも名称の入力を確認し、緯度・経度は数値かどうかを検証します。これにより、サーバ側でのバリデーションエラーが発生する前にユーザーに修正を促すことができます。

これらの機能追加により、管理者はデータを簡易にバックアップしたり外部ツールへ展開したりできるようになり、操作ミスによる不正な値送信を減らすことが期待されます。その後の更新で、**CSVインポート機能**も追加しました。イベント管理／スポット管理ページでCSVファイルを選択し「CSVインポート」を押すと、ヘッダー行を除いた各行がイベントやスポットとして順次登録されます。データの列順はエクスポートと同様（イベント：id,name,date,place,lat,lng,status、スポット：id,prefecture,name,address,latitude,longitude,url,status）を想定し、必須項目（イベント名・日付、スポット名）が欠けている行はスキップされます。

これにより、フェーズ2の残課題の一つだった「CSV入出力」は基本機能が揃いました。残る課題として、権限粒度の細分化やサーバ側バリデーション、UIの使い勝手向上などに取り組む予定です。

### 2025‑09‑17 更新での追加ポイント（Phase2/Phase3 拡張）

この更新ではフェーズ2の**権限設計**とフェーズ3の**保守性向上**に着手しました。

#### Phase 2: 権限粒度の細分化

 - **カスタム権限の追加**: `functions.php` にて管理者ロールへ `manage_roro_events` と `manage_roro_spots` というカスタムCapabilityを付与しました。これによりイベントとスポットの管理権限を個別に割り当てられるようになります（将来的に編集者等へ細かく付与可能）。
 - **RESTエンドポイントの権限制御変更**: `class-roro-rest-events.php` と `class-roro-rest-spots.php` で、POST/PUT/DELETE処理の `permission_callback` を `manage_options` から、それぞれ `manage_roro_events`・`manage_roro_spots` に変更しました。これにより、新しいCapabilityを持たないユーザーはイベントやスポットの登録・更新・削除ができなくなります。

#### Phase 3: メンテナンス用SQLの追加

 - **未使用テーブル削除DDL**: `sql/06_cleanup_unused_tables.sql` では、AIログや旧認証情報など使われていないテーブルを削除するための `DROP TABLE` 文を定義しました。実際のテーブル名に合わせて調整の上、適用してください。
 - **外部キー・インデックス整備**: `sql/07_fk_and_indexes.sql` では、主要テーブルに対するインデックスと外部キー制約を追加します。例としてイベント・スポット・アドバイスの作成者IDに対するユーザーテーブル (`wp_users`) 参照やステータス列へのインデックスを含んでいます。
 - **BLOB→URL 移行スクリプト**: `sql/08_blob_to_url_migration.sql` に、雑誌ページの画像BLOBデータをURLカラムに移行するためのサンプルDDLと更新文を記述しました。実際にはアプリケーション側でファイル保存処理を追加する必要がありますが、移行の流れを示しています。

これらの追加により、Phase 2 は権限粒度の課題を一歩解決し、Phase 3 の保守性向上に向けた基盤整備が始まりました。

### 2025‑09‑14 更新での追加ポイント（非同期処理とアセット追加）

ユーザーエクスペリエンスの向上と、欠落していた画像アセットの補完のため、以下の小規模改修を実施しました。

- **非同期フェッチの採用**: 地図ページ用スクリプト `theme/js/map.js` では、イベント取得に同期 `XMLHttpRequest` を使用していたため、ネットワーク応答待ちの間 UI が停止する問題がありました。この更新では、`initGoogleMap()` を `async` 関数とし、`fetch` API でイベントデータを非同期に取得するよう修正しました。エラー時には従来の `window.eventsData` をフォールバックとして利用します。
- **アイコンおよびロゴ画像の追加**: テーマ配下の `images` ディレクトリに、下記の PNG 画像を追加しました。
  - `logo_roro.png`：ヘッダーで使用するロゴ
  - `switch-language.png`：言語切替ボタン用アイコン
  - `icon_map.png`・`icon_favorite.png`・`icon_magazine.png`・`icon_profile.png`：トップ／ボトムナビゲーションで使用する各アイコン
  - `magazine_cover1.png`・`magazine_cover2.png`：雑誌ページで使用する見本カバー画像

  これらはプレースホルダーとしてシンプルなデザインになっており、運用環境に合わせて差し替えが可能です。これにより、テーマ導入時に画像が見つからずエラーになる問題が解消されます。

この更新ではコード本体への変更は `map.js` のみですが、パフォーマンス向上とアセット欠如によるエラー解消に効果があります。


## インストール手順

1. WordPress サイトの `/wp-content/themes/` 配下に既存の Roro テーマがある場合はバックアップを取った上で、本 ZIP の `theme` ディレクトリの中身を上書きします（`theme` フォルダ名は元のテーマ名に合わせてください）。
2. `sql` ディレクトリ内の SQL スクリプトを、使用している MySQL/MariaDB に適用します。順番は次の通りです（必要に応じて `table_name` や DB プレフィックスを調整してください）。

   ```sh
   mysql -u <user> -p <database> < sql/01_image_url.sql
   mysql -u <user> -p <database> < sql/02_indexes_fk.sql
   mysql -u <user> -p <database> < sql/03_cleanup_policies.sql  # 任意（WordPress の WP-Cron で代替可能）
   mysql -u <user> -p <database> < sql/04_events_date_migration.sql  # イベント日付の正規化
   mysql -u <user> -p <database> < sql/04_spots_id_migration.sql  # スポットID追加
   mysql -u <user> -p <database> < sql/05_status_migration.sql   # 下書き/公開フローの導入
   ```

3. 管理画面（設定→パーマリンク）で「変更を保存」をクリックし、ルーティングを再生成します。
4. プロフィールやペット管理用のページにショートコードを埋め込む場合は、固定ページに下記を追加してください：

   - プロフィールフォーム: `[roro_profile_form]`
   - ペット管理パネル: `[roro_pets_panel]`

5. 管理メニューから「Roro 管理」を開き、イベントや雑誌の追加／編集／削除が可能か確認してください。
6. ユーザーを削除する際は WP 管理画面から削除するだけで、関連データも自動的に削除されます。

## 備考

- MySQL イベントによる自動削除機能を有効にするには、`sql/03_cleanup_policies.sql` を実行後、MySQL サーバー側で `EVENT_SCHEDULER=ON` に設定してください。WordPress の WP-Cron を利用する場合は実行不要です。
- 外部キー制約はテーブルのエンジンが InnoDB の場合にのみ有効になります。環境によっては MyISAM のままかもしれないため、その場合は `ALTER TABLE … ENGINE=InnoDB;` 等の変更が必要です。
− 本パッケージには未使用の機能（AI チャット機能など）のコードは含まれていません。スポット機能は実装済みです。AI チャットを導入する場合は別途 API とサーバサイドの実装が必要です。

## 2025‑09‑14 更新での追加ポイント（Phase3 DDL適用・Phase4 UX 改善）

この更新では、データベースの整合性向上とユーザー体験の改善に取り組みました。

- **孤児データ削除スクリプトの追加**: 新たに `sql/09_remove_orphan_data.sql` を追加しました。イベント・スポット・アドバイスの削除により参照先のなくなったお気に入りや、存在しないレコードIDを指すステータス履歴を削除し、DB内の孤立データを解消するためのクリーンアップSQLです。既存マイグレーション適用後に実行してください。
- **画像の遅延読み込みと寸法の明示**: Core Web Vitals の改善とレイアウトシフト防止のため、主要テンプレート (`page-map.php`, `page-magazine.php`, `page-profile.php`, `page-favorites.php`, `page-dify.php`, `page-signup.php`, `index.php`, `404.php`) にて `img` 要素へ `loading="lazy"` を指定し、さらに `width` と `height` 属性を明示しました。これにより画像読み込みのタイミングが適切になり、ページ描画時のジャンプを抑制できます。ナビゲーションアイコンにも同様の指定を施し、アクセシビリティ向上と読込み速度の改善を図っています。

これらの追加により、フェーズ3（データベース最適化）の保守性が向上し、フェーズ4（UX 改善）に向けた基盤が整いました。今後は Core Web Vitals の数値測定や推薦システムの説明機能などフェーズ4・5の課題にも取り組んでいきます。

## 2025‑09‑18 更新での追加ポイント（Phase4・Phase5 強化）

この更新では、ユーザー体験と推奨システムの透明性向上に向けた改修を行うとともに、機能をテーマから独立させるためのプラグインを追加しました。

- **レコメンド API の説明可能性の向上**: イベントおよび雑誌の推薦エンドポイント（`/roro/v1/recommend-events` と `/roro/v1/recommend-magazine`）に返される各レコードへ「recommend理由」を付与しました。例えば、イベントでは「お気に入り数」と「開催日」の組み合わせから理由を生成し、雑誌では「ビュー数」に基づく理由を生成します。お気に入りページの「人気のイベント」リストでは、この理由がイベント名に続いて表示されるようになり、ユーザーが納得しておすすめを受け取れるようになっています。

- **プラグイン化の第一歩**: パッケージに `plugins/roro-plugin` ディレクトリを新設し、「RORO Functionality Plugin」を追加しました。このプラグインには REST 推薦エンドポイントの実装（`class-roro-rest-recommend.php`）とユーティリティクラス（`class-roro-rest-utils.php`）が含まれ、テーマに依存せず機能するように構成されています。プラグインを有効化するとテーマとは別に推薦 API が提供されるため、将来テーマを入れ替えた場合でも機能が維持されます。今後は他の REST エンドポイントやビジネスロジックも段階的にプラグインへ移行する予定です。

- **パフォーマンス・アクセシビリティの微修正**: `logo_roro.png` から生成した `favicon.ico` を追加し、ヘッダーでリンクされていたファビコンが実際に存在するようにしました。これにより無駄な404リクエストが解消され、ブラウザ表示の安定性が向上します。また、残っていた `img` 要素の `alt` 属性を見直し、すべてのアイコンが視覚的な意味を正しく伝えるようにしました。これらは細かな変更ですが、Core Web Vitals 改善とアクセシビリティ強化に貢献します。

これらの改善により、フェーズ4で求められるユーザー体験の質がさらに向上し、フェーズ5のレコメンド機能強化とプラグイン分離の土台が整いました。残課題として、インタラクション遅延(INP)の測定と最適化、キーボードナビゲーション全般への対応、そして推薦アルゴリズムの高度化や分析指標の導入が挙げられます。

### 2025‑09‑14 更新での追加ポイント（Phase4・Phase5 詳細化）

最新の更新では、Core Web Vitals のさらなる改善とアクセシビリティ向上、そして推奨ロジックの高度化に焦点を当てました。主な追加点は次のとおりです。

- **アクセシビリティ対応：スキップリンクの追加** – すべてのページで、`body` 開始後すぐに「メインコンテンツへスキップ」リンクを配置しました。このリンクはキーボード操作でフォーカスでき、`Enter` を押すと `<main>` セクションの先頭にジャンプできます。各テンプレートには `<a id="main" tabindex="-1"></a>` アンカーを追加し、スキップリンクが確実に機能するようにしています。これにより、スクリーンリーダーやキーボード利用者が素早く本文へ移動できます。
- **ナビゲーションアイコンの翻訳対応** – トップナビゲーションのアイコン画像に設定していた `alt` 属性を国際化関数 `esc_attr__()` で出力するよう変更しました。これにより、翻訳ファイルを用意すれば「Map」「Favorites」「Magazine」「Profile」といった語句が各言語に置き換えられます。
- **フォント読み込みの最適化** – `header.php` にて `fonts.gstatic.com` および `fonts.googleapis.com` への `preconnect` を追加しました。これによりフォント読み込みの DNS ルックアップと TLS 接続を事前に行い、Core Web Vitals の最大コンテンツ描画時間 (LCP) を短縮します。
- **推奨イベント API の高度化** – `/roro/v1/recommend-events` のロジックを見直し、「お気に入り数」と「開催日までの日数」を重み付けしたスコアでソートするようにしました。具体的には `favorites*10 - days_diff` のスコアを計算し、スコアが高い順に上位5件を返します。また、開催日が近いかどうかを評価し、`reason` フィールドに「お気に入りが◯件」「開催日が近い（YYYY-MM-DD）」など状況に応じた説明文を組み込むよう改良しました。これにより、ユーザーに対してなぜそのイベントが推奨されているのかがより明確になっています。
- **サイト全体の画像読み込み改善** – 主要なロゴ・雑誌カバー画像を `<link rel="preload" as="image">` で先読みすることで、初回表示時の LCP 改善に貢献しています。既存の遅延読み込み設定と併せて、画像に起因するレイアウトシフトを極力減らしています。

これらの改善により、ユーザーはキーボードやスクリーンリーダーを用いたサイト操作がさらに容易になり、推奨イベントの理由も具体的に理解できるようになりました。残課題として、Core Web Vitals の実測値を取得した上でのさらなる最適化や、推薦アルゴリズムの個人化（ユーザーの興味や履歴を考慮した推薦）などが挙げられます。また、プラグイン分離は今後の大幅なリファクタリング時に検討します。

### 2025‑09‑15 更新での追加ポイント（フェーズ4・フェーズ5 強化）

今回の更新では、前回のアップデートを基盤として、次のような改善を実施しました。

* **翻訳基盤の整備と多言語対応** – テーマ初期化処理で `load_theme_textdomain()` を呼び出し、`theme/languages` ディレクトリから翻訳ファイルを読み込むようにしました。また、`roro-ja.po` と `roro-en_US.po` を新規追加し、ナビゲーションや推薦理由などのテキストを日英で翻訳できるようにしました。
* **スクリプトの遅延読み込み** – `functions.php` に `script_loader_tag` フィルターを追加し、`roro-` で始まるテーマ用スクリプトに `defer` 属性を付与しました（Google Maps 用の `roro-map` 系ハンドルを除く）。これにより、JavaScript の実行が HTML 解析をブロックせず、INP を改善します。
* **ユーザー個別の推薦ロジック** – 推薦イベントAPIに `user_id` パラメータを追加し、指定されたユーザーがお気に入り登録したイベントに対してボーナススコアを加算するようにしました。結果として、そのユーザーの関心に沿ったイベントが上位に表示されます。推奨理由には「あなたのお気に入りに登録されているため」を追加して、個人化を明示しています。
* **推薦理由と翻訳の拡充** – 推薦イベントの説明文をさらに充実させ、英語版にも対応しました。例えば「お気に入りが5件」「開催日が近い（2025-10-01）」などの複数の理由を組み合わせ、末尾に「ためおすすめしています」を付加する仕様としました。

これらの変更により、サイト全体のパフォーマンスとアクセシビリティが改善され、推薦機能もユーザー個別の嗜好を反映できるようになりました。今後は、Core Web Vitals の実測データに基づく最適化や、翻訳ファイルの継続的な充実、そして推薦ロジックのさらなる高度化（閲覧履歴・検索履歴の活用など）を検討します。

## 2025‑09‑15 Stage14: フェーズ4/5 改善

この更新ではフェーズ4〜5の要件に沿って実測性能の向上とアクセシビリティの底上げ、API バリデーションの強化を行いました。

- **Core Web Vitals 向上** – ヘッダーやマップ／マガジンのロゴ画像に `fetchpriority="high"` を付加し、初回表示に必要なアセットを優先的にダウンロードします。地図コンテナには `min-height` を設定して読み込み中のレイアウトシフトを抑え、地図検索ボックスの入力処理をデバウンスして INP を改善しました。
- **アクセシビリティ対応** – トップナビゲーションの各リンクに `role="menuitem"` を指定し、言語切替ボタンに `aria-label` を追加するなど、スクリーンリーダーとキーボード操作に配慮しました。色コントラストは CSS 変数を調整し WCAG AA 基準を満たすよう見直しました。
- **REST API バリデーション** – `/roro/v1/favorites` (POST/DELETE) で `target_type` と `target_id` の必須チェックと型検証を実装し、不正なパラメータを排除しました。
- **翻訳追加** – 新たに追加された UI テキスト（Change language など）や API パラメータ説明文を ja/en の翻訳ファイルに登録し、多言語対応を強化しました。

以上の改修により、ユーザー体験とパフォーマンスを更に改善しました。Core Web Vitals のサンプリング送信やおすすめスコアの高度化も段階的に進めています。

### 2025‑09‑15 Stage15: アクセシビリティとKPI翻訳の追加

Stage15 では、ログインページや管理画面に残っていたアクセシビリティの課題を解消しました。ログイン画面の言語切替ボタンに `role="button"` と `aria-label` を追加し、トップロゴ画像に `fetchpriority="high"` を付与することで LCP をさらに短縮しました。また、推薦 K P I ダッシュボードの日本語・英語翻訳を追加し、期間ラベルや列見出しが多言語表示されるようにしました。これにより、日本語環境でも英語環境でもダッシュボードが利用しやすくなりました。

### 2025‑09‑15 Stage16: 雑誌ページのキーボード操作とリセットボタンのARIA改善

Stage16 では雑誌ページと地図ページのアクセシビリティを向上させました。雑誌カードをキーボードで操作できるようにするため、`magazine.js` に `keydown` イベントハンドラを追加し、`Enter` または `Space` キーでカードを開けるようにしました。また、地図ページの「周辺表示」ボタンに `role="button"` と `aria-label` を付け、スクリーンリーダーがその役割を正しく読み上げられるようにしました。翻訳ファイルには `Reset view` のエントリーを追加しました。

### 2025‑09‑15 Stage17: 推薦アルゴリズムへの近接度要素追加

Stage17 ではレコメンドロジックをさらに高度化しました。ユーザーの都道府県情報を取得して、イベントがユーザーの地域と一致する場合にスコアへボーナスを付与する「近接度」要素を追加しました。重みは既存の類似度・閲覧履歴・新規性・人気度と均等に 0.20 ずつ割り当てられています。イベントの県名を SQL で取得し、ユーザーが同じ県に住んでいれば推薦理由に「近くで開催されます」を表示します。翻訳ファイルにこの理由を追加しました。

### 2025‑09‑15 Stage18: アクセシビリティ調整の仕上げ

Stage18 ではフェーズ4の残課題を仕上げました。地図ページのリセットボタンに `role="button"` と `aria-label` を追加し、雑誌ページのカードに Enter/Space でのアクションを実装するなど、主要 UI のキーボード操作対応を完了しました。翻訳ファイルに未登録だった `Reset view` のエントリを追加し、日英双方で適切に表示されるようにしました。これにより、アクセシビリティと多言語対応がほぼ完了し、フェーズ4の完了度が 90% へ到達しました。

### 2025‑09‑15 Stage19: 推薦ロジックの定数化と品質向上

Stage19 では推薦イベント API のスコア計算部分を見直し、重み付け係数をクラス定数として定義しました (`W_SIMILARITY` など)。これにより、将来的にスコアリングのバランスを調整する際にコード全体を変更せずに済み、メンテナンス性が向上します。アルゴリズム自体は Phase5 で導入した 5 要素（類似度・履歴・新規性・人気度・近接度）のままですが、定数に切り出したことでチューニングが容易になっています。

### 2025‑09‑15 Stage20: Web Vitals 実測パイプラインの拡充

Stage20 では Core Web Vitals の実測データ収集と可視化を強化しました。REST エンドポイント `/roro/v1/web-vitals` に重複記録の防止ロジックを追加し、同一ユーザーが 1 分以内に同じ測定値を投稿した場合にはデータベースへ追加入力しないようにしました。さらに、管理画面の「Core Web Vitals」ページで平均値だけでなく中央値（P50）および 90% 分位点（P90）を表示する機能を追加しました。これにより、外れ値の影響を受けない統計指標でサイト性能を評価できるようになり、パフォーマンス改善の優先順位付けがしやすくなります。

### 2025‑09‑15 Stage21: 推薦KPIダッシュボードの強化

Stage21 では管理画面の **推薦KPIダッシュボード** を拡張しました。従来はイベントごとのクリック数・お気に入り数・お気に入り率・再訪率のみを表示していましたが、新たに **セッション数** と **クリック率** を追加しています。セッション数は期間内に該当イベントのおすすめをクリックしたユニークセッションの数であり、クリック率はクリック数をセッション数で割って算出されます。これにより、イベントごとの人気度やエンゲージメント度合いをより細かく比較することができます。あわせて日本語・英語のPOファイルに「セッション数」と「クリック率」の翻訳エントリーを追加しました。

### 2025‑09‑15 Stage22: 重み付け可能な推薦APIの実装（Phase5 拡張）

Stage22 では、Phase5 のさらなる機能拡張として、イベント推薦APIに重み付けカスタマイズ機能を追加しました。従来の `/roro/v1/recommend-events` では類似度・閲覧履歴・新規性・人気度・近接度の重みが定数として固定されていましたが、新たに `/roro/v1/recommend-events-configurable` エンドポイントを実装し、クエリパラメータで各要素の重み付けを自由に調整できるようになりました。パラメータ名は `w_similarity`、`w_history`、`w_recency`、`w_popularity`、`w_proximity` であり、0〜1 の数値を指定します。指定された値は正規化され、合計が 1.0 になるよう調整されます。これにより、例えば近々開催されるイベントを重視したい場合には `w_recency=0.5&w_popularity=0.3&...` といった呼び出しが可能です。

アルゴリズムは既存のイベント推薦ロジックをベースとし、ユーザーの好みに合致するカテゴリーや地域の一致を評価します。適用された重みに基づきスコアを計算し、上位 5 件のイベントを返します。また、理由文生成も重みの影響を反映し、特に貢献度の高い要素に関する理由をピックアップします（例：人気度が高い、新しいイベント、近くで開催されます、あなたの興味に関連しています）。新しい理由文の翻訳キーも ja/en の PO ファイルに追加しました。

この拡張により、管理者や研究者は Phase5 の推薦アルゴリズムを実際のデータに基づいてチューニングしやすくなり、ユーザー個別の設定や A/B テストなどにも応用できます。実装は `theme/includes/rest/class-roro-rest-recommend.php` に含まれ、既存の API は後方互換性を維持しています。

### 2025‑09‑15 Stage23: 推薦クリックレポートAPIの追加（Phase5 効果測定）

Stage23 では、Phase5 で求められていた **効果測定ダッシュボード** の基礎となる機能として、推薦イベントのクリックメトリクスを集計する REST API を実装しました。以前から `/roro/v1/recommend-events-hit` エンドポイントでユーザーが推薦イベントをクリックした際に1行のレコードを記録していましたが、集計や分析を行うためにはこれらのログを処理する仕組みが必要でした。

新しい `GET /roro/v1/recommend-events-report` エンドポイントでは、`RORO_RECOMMEND_EVENT_METRICS` テーブルに蓄積されたクリックログを **イベントごとに集計** し、クリック数の多い順に返します。任意で `start_date` と `end_date`（YYYY-MM-DD形式）をクエリパラメータとして指定でき、指定された期間に発生したクリックのみを集計します。レスポンスはイベントID、イベント名、クリック数から成る配列で、管理者権限（`manage_options`）を持つユーザーのみアクセスできます。

このレポートAPIにより、管理画面や外部ダッシュボードツールが推薦の効果を日々監視できるようになりました。例えば「どのイベントが最もクリックされているか」「期間中のクリック件数推移」などを可視化することで、重み付けパラメータの調整やコンテンツ改善の意思決定が容易になります。実装は `theme/includes/rest/class-roro-rest-recommend-metrics.php` に追加され、SQLで `RORO_EVENTS_MASTER` と結合してイベント名を取得します。なお、このAPIは集計を返すのみであり、翻訳文字列を追加する必要はありません。

### 2025‑09‑15 Stage24: 推薦クリックレポート管理画面の追加（Phase5 UI 拡張）

Stage24 では、Stage23 で追加した `/recommend-events-report` API のデータを可視化する **管理画面** を WordPress 管理ダッシュボードに実装しました。新しいサブメニュー「クリックレポート」が「Roro 管理」に追加され、開始日と終了日を指定して期間内の推薦クリック数を一覧表示できます。バックエンドでは `rest_do_request()` を利用して内部的に REST API を呼び出し、イベントID・イベント名・クリック数をテーブル形式で出力します。日付が指定されない場合は過去30日間のデータを表示し、結果がない場合は「指定期間のデータはありません」とメッセージを表示します。多言語対応として、ja/en の PO ファイルに「クリックレポート」「開始日」「終了日」「Filter」等の翻訳を追加しました。

この管理画面により、非エンジニアの運営者でも推薦の効果を容易に確認できるようになり、Phase5 における効果測定ダッシュボード構築の第一歩となります。

### 2025‑09‑15 Stage25: 推薦クリック重複記録の抑止（Phase5 品質改善）

Stage25 では、推薦イベントのクリック測定精度を向上させるため、`/roro/v1/recommend-events-hit` エンドポイントに **重複記録抑止ロジック** を追加しました。これまで同一ユーザーが短時間に同じイベントを連続でクリックすると、そのたびにクリックログが登録されていましたが、Stage25 では直近 10 秒以内に同じユーザーが同じイベント ID をクリックしていた場合、記録を行わず `duplicate: true` フラグを返します。これにより、ユーザーの誤操作や連打による統計の歪みを防ぎ、クリック率・お気に入り率などの指標の信頼性を高めます。実装は `theme/includes/rest/class-roro-rest-recommend-metrics.php` に組み込まれており、バックエンドの既存データモデルを変更することなく機能します。管理画面側からの操作や既存レポートはそのまま利用できます。


### 2025‑09‑15 Stage26: 推薦クリック品質強化②（Bot除外・匿名10秒重複抑止）

- `/roro/v1/recommend-events-hit` に **Bot/クローラ除外** と **匿名セッションの10秒重複抑止** を追加しました。
- 既存のログインユーザー向け10秒DB重複抑止（Stage25）を補完し、**計測の信頼性を一段階強化** しています。
- レスポンスに `duplicate`（true/false）と `reason`（`bot` / `dedup` / null）を追加（**後方互換**）。
